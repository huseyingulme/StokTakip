{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - StokTakip{% endblock %}
{% block page_title %}<i class="bi bi-speedometer2"></i> Dashboard{% endblock %}

{% block content %}

<!-- Hoş Geldiniz Mesajı -->
<div class="welcome-banner mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h3 class="mb-1 text-white">Hoş Geldiniz, <span>{% if user.first_name %}{{ user.first_name }}{% else %}{{
                    user.username }}{% endif %}!</span></h3>
            <p class="mb-0 text-white-50">{{ "now"|date:"l, d F Y" }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{% url 'accounts:profile' %}" class="btn btn-glass">
                <i class="bi bi-person-circle"></i> Profilim
            </a>
        </div>
    </div>
</div>

<!-- Ana İstatistik Kartları -->
<div class="row g-4 mb-4">
    <!-- Stok İstatistikleri -->
    <div class="col-lg-3 col-md-6">
        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="bi bi-box-seam"></i>
            </div>
            <div class="stat-content">
                <h3>{{ toplam_urun_sayisi }}</h3>
                <p>Toplam Ürün</p>
            </div>
        </div>
    </div>


    <div class="col-lg-3 col-md-6">
        <div class="stat-card stat-danger">
            <div class="stat-icon">
                <i class="bi bi-x-circle"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stoksuz_urunler }}</h3>
                <p>Stoksuz Ürün</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="bi bi-currency-dollar"></i>
            </div>
            <div class="stat-content">
                <h3>{{ toplam_stok_degeri|floatformat:0|default:"0" }} ₺</h3>
                <p>Stok Değeri</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="bi bi-person-check"></i>
            </div>
            <div class="stat-content">
                <h3>{{ musteri_sayisi }}</h3>
                <p>Aktif Müşteri</p>
            </div>
        </div>
    </div>
</div>

<!-- Cari ve Fatura İstatistikleri -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="bi bi-people"></i>
            </div>
            <div class="stat-content">
                <h3>{{ toplam_cari_sayisi }}</h3>
                <p>Toplam Cari</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="bi bi-cash-stack"></i>
            </div>
            <div class="stat-content">
                <h3>{{ toplam_alacak|floatformat:2|default:"0" }} ₺</h3>
                <p>Toplam Alacak</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="bi bi-receipt"></i>
            </div>
            <div class="stat-content">
                <h3>{{ bu_ay_fatura }}</h3>
                <p>Bu Ay Fatura</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="bi bi-cash-coin"></i>
            </div>
            <div class="stat-content">
                <h3>{{ bu_ay_ciro|floatformat:2|default:"0" }} ₺</h3>
                <p>Bu Ay Ciro</p>
            </div>
        </div>
    </div>
</div>


<!-- Sipariş İstatistikleri -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <a href="{% url 'musteri_paneli:admin_siparis_listesi' %}?durum=beklemede"
            class="text-decoration-none h-100 d-block">
            <div
                class="stat-card {% if bekleyen_siparis_sayisi > 0 %}stat-warning animated-pulse{% else %}stat-info{% endif %}">
                <div class="stat-icon">
                    <i class="bi bi-cart-fill"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ bekleyen_siparis_sayisi }}</h3>
                    <p>Bekleyen Sipariş</p>
                </div>
                {% if bekleyen_siparis_sayisi > 0 %}
                <div class="stat-badge">YENİ</div>
                {% endif %}
            </div>
        </a>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="mini-stat-card">
            <div class="mini-stat-icon bg-primary">
                <i class="bi bi-calendar-day"></i>
            </div>
            <div class="mini-stat-content">
                <h4>{{ bugun_satis|floatformat:2|default:"0" }} ₺</h4>
                <p>Bugünkü Satış</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="mini-stat-card">
            <div class="mini-stat-icon bg-info">
                <i class="bi bi-calendar-week"></i>
            </div>
            <div class="mini-stat-content">
                <h4>{{ bu_hafta_satis|floatformat:2|default:"0" }} ₺</h4>
                <p>Bu Hafta Satış</p>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-md-6">
        <div class="mini-stat-card">
            <div class="mini-stat-icon bg-secondary">
                <i class="bi bi-files"></i>
            </div>
            <div class="mini-stat-content">
                <h4>{{ toplam_fatura_sayisi }}</h4>
                <p>Toplam Fatura</p>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes pulse-warning {
        0% {
            box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(245, 158, 11, 0);
        }
    }

    .animated-pulse {
        animation: pulse-warning 2s infinite;
    }

    .stat-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #ef4444;
        color: white;
        font-size: 0.7rem;
        font-weight: 800;
        padding: 2px 8px;
        border-radius: 4px;
        animation: fadeIn 0.5s ease;
    }
</style>

<!-- En Çok Satan Ürünler ve Vadesi Yaklaşan Faturalar -->
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0"><i class="bi bi-trophy text-warning"></i> Bu Ay En Çok Satan Ürünler</h5>
            </div>
            <div class="card-body">
                {% if en_cok_satan_urunler %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Ürün</th>
                                <th class="text-center">Miktar</th>
                                <th class="text-end">Toplam</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for urun in en_cok_satan_urunler %}
                            <tr>
                                <td>
                                    <strong>{{ urun.urun_adi }}</strong>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ urun.toplam_miktar }}</span>
                                </td>
                                <td class="text-end">
                                    <strong>{{ urun.toplam_tutar|floatformat:2 }} ₺</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                    <p class="text-muted mt-3">Henüz satış verisi yok</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Stoksuz Ürünler -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0"><i class="bi bi-exclamation-octagon text-danger"></i> Stoksuz Ürünler</h5>
            </div>
            <div class="card-body">
                {% if stoksuz_urun_listesi %}
                <div class="list-group list-group-flush">
                    {% for urun in stoksuz_urun_listesi|slice:":5" %}
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ urun.ad }}</strong>
                                <br>
                                <small class="text-muted">{{ urun.barkod|default:"Barkodsuz" }}</small>
                            </div>
                            <span class="badge bg-danger">0 Stok</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-check-circle" style="font-size: 3rem; color: #28a745;"></i>
                    <p class="text-muted mt-3">Tüm ürünler stokta mevcut</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Son Eklenenler -->
<div class="row g-4">
    <div class="col-lg-4">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0"><i class="bi bi-box-seam text-primary"></i> Son Eklenen Ürünler</h5>
            </div>
            <div class="card-body">
                {% if son_urunler %}
                <div class="list-group list-group-flush">
                    {% for urun in son_urunler %}
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ urun.ad }}</strong>
                                <br>
                                <small class="text-muted">{{ urun.fiyat|floatformat:2 }} ₺</small>
                            </div>
                            <span class="badge {% if urun.mevcut_stok == 0 %}bg-danger{% else %}bg-success{% endif %}">
                                {{ urun.mevcut_stok }}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-3">Henüz ürün eklenmemiş</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0"><i class="bi bi-people text-info"></i> Son Eklenen Cariler</h5>
            </div>
            <div class="card-body">
                {% if son_cariler %}
                <div class="list-group list-group-flush">
                    {% for cari in son_cariler %}
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ cari.ad_soyad }}</strong>
                                <br>
                                <small class="text-muted">{{ cari.get_kategori_display }}</small>
                            </div>
                            <span class="badge bg-info">{{ cari.telefon|default:"-" }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-3">Henüz cari eklenmemiş</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0">
                <h5 class="mb-0"><i class="bi bi-receipt text-success"></i> Son Faturalar</h5>
            </div>
            <div class="card-body">
                {% if son_faturalar %}
                <div class="list-group list-group-flush">
                    {% for fatura in son_faturalar %}
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>
                                    <a href="{% url 'fatura:detay' fatura.pk %}" class="text-decoration-none">
                                        {{ fatura.fatura_no }}
                                    </a>
                                </strong>
                                <br>
                                <small class="text-muted">{{ fatura.cari.ad_soyad|default:"-" }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success">{{ fatura.genel_toplam|floatformat:2 }} ₺</span>
                                <br>
                                <small class="text-muted">{{ fatura.fatura_tarihi|date:"d.m.Y" }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center py-3">Henüz fatura oluşturulmamış</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Son Siparişler -->
<div class="row g-4 mt-2 mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0 text-primary fw-bold"><i class="bi bi-cart"></i> Son Müşteri Siparişleri</h5>
                <a href="{% url 'musteri_paneli:admin_siparis_listesi' %}"
                    class="btn btn-sm btn-outline-primary rounded-pill">Tümünü Yönet</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-muted small text-uppercase">
                            <tr>
                                <th class="px-4 border-0">Sipariş No</th>
                                <th class="border-0">Müşteri</th>
                                <th class="border-0">Tarih</th>
                                <th class="border-0">Tutar</th>
                                <th class="border-0">Durum</th>
                                <th class="text-end px-4 border-0">İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for siparis in son_siparisler %}
                            <tr>
                                <td class="px-4 fw-medium text-primary">{{ siparis.siparis_no }}</td>
                                <td class="fw-bold">{{ siparis.cari.ad_soyad }}</td>
                                <td class="text-muted small">{{ siparis.olusturma_tarihi|date:"d.m.Y H:i" }}</td>
                                <td class="fw-bold text-success">{{ siparis.toplam_tutar|floatformat:2 }} ₺</td>
                                <td>
                                    {% if siparis.durum == 'beklemede' %}
                                    <span class="badge bg-warning-subtle text-warning rounded-pill">Onay Bekliyor</span>
                                    {% elif siparis.durum == 'onaylandi' %}
                                    <span class="badge bg-info-subtle text-info rounded-pill">İşlemde</span>
                                    {% elif siparis.durum == 'faturalandi' %}
                                    <span class="badge bg-success-subtle text-success rounded-pill">Tamamlandı</span>
                                    {% else %}
                                    <span class="badge bg-secondary-subtle text-secondary rounded-pill">{{
                                        siparis.get_durum_display }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end px-4">
                                    <a href="{% url 'musteri_paneli:admin_siparis_detay' siparis.pk %}"
                                        class="btn btn-sm btn-primary rounded-pill px-3">Yönet</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <i class="bi bi-inbox d-block fs-2 mb-2"></i>
                                    Henüz sipariş kaydı bulunmamaktadır
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    /* * DASHBOARD PREMIUM UI STYLE PACK 
 * Özellikler: Mesh Gradient, Glassmorphism, CSS Variables, Responsive Design
 */

    :root {
        /* Renk Paleti */
        --dash-primary: #6366f1;
        --dash-primary-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        --dash-success: #22c55e;
        --dash-success-gradient: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
        --dash-warning: #f59e0b;
        --dash-warning-gradient: linear-gradient(135deg, #f59e0b 0%, #ed8936 100%);
        --dash-danger: #ef4444;
        --dash-danger-gradient: linear-gradient(135deg, #ef4444 0%, #e11d48 100%);
        --dash-info: #0ea5e9;
        --dash-info-gradient: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);

        /* Arka Plan ve Gölgeler */
        --dash-bg: #f8fafc;
        --card-bg: rgba(255, 255, 255, 0.9);
        --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --card-shadow-hover: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

        /* Geçişler */
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Genel Sayfa Ayarları */
    body {
        background-color: var(--dash-bg);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    /* 1. Hoşgeldiniz Banner - Dinamik Mesh Gradient */
    .welcome-banner {
        background: rgb(42, 82, 152);
        background-size: 200% 200%;
        animation: meshGradient 15s ease infinite;
        padding: 35px 40px;
        border-radius: 20px;
        color: white;
        box-shadow: 0 10px 30px -10px rgba(99, 102, 241, 0.5);
        margin-bottom: 2rem;
    }

    .btn-glass {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 10px 20px;
        border-radius: 12px;
        transition: var(--transition);
    }

    .btn-glass:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-2px);
    }

    .text-white-50 {
        color: rgba(255, 255, 255, 0.7) !important;
    }

    @keyframes meshGradient {
        0% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }

        100% {
            background-position: 0% 50%;
        }
    }

    /* 2. Ana İstatistik Kartları (Stat Cards) */
    .stat-card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border-radius: 18px;
        padding: 24px;
        border: 1px solid rgba(255, 255, 255, 0.7);
        box-shadow: var(--card-shadow);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
        background: #ffffff;
    }

    /* Kartın soluna renkli vurgu çizgisi */
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 6px;
        height: 100%;
        transition: var(--transition);
    }

    .stat-primary::before {
        background: var(--dash-primary);
    }

    .stat-success::before {
        background: var(--dash-success);
    }

    .stat-warning::before {
        background: var(--dash-warning);
    }

    .stat-danger::before {
        background: var(--dash-danger);
    }

    .stat-info::before {
        background: var(--dash-info);
    }

    /* İkon Tasarımı */
    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        flex-shrink: 0;
    }

    .stat-primary .stat-icon {
        background: var(--dash-primary-gradient);
    }

    .stat-success .stat-icon {
        background: var(--dash-success-gradient);
    }

    .stat-warning .stat-icon {
        background: var(--dash-warning-gradient);
    }

    .stat-danger .stat-icon {
        background: var(--dash-danger-gradient);
    }

    .stat-info .stat-icon {
        background: var(--dash-info-gradient);
    }

    /* İçerik ve Fontlar */
    .stat-content h3 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 800;
        color: #1e293b;
        letter-spacing: -0.5px;
    }

    .stat-content p {
        margin: 0;
        color: #64748b;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    /* 3. Mini İstatistik Kartları */
    .mini-stat-card {
        background: white;
        border-radius: 14px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        border: 1px solid #f1f5f9;
    }

    .mini-stat-card:hover {
        border-color: var(--dash-primary);
        transform: scale(1.02);
    }

    .mini-stat-icon {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
    }

    /* 4. Tablo ve İçerik Kartları */
    .card {
        border: none;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
    }

    .card-header {
        background: #ffffff;
        padding: 20px 25px;
        border-bottom: 1px solid #f1f5f9;
    }

    .card-header h5 {
        font-weight: 700;
        color: #334155;
    }

    .table thead th {
        background-color: #f8fafc;
        text-transform: uppercase;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        color: #64748b;
        border-top: none;
    }

    /* 5. Liste Öğeleri ve Badge'ler */
    .list-group-item {
        transition: var(--transition);
        border-radius: 12px !important;
        margin-bottom: 8px;
        border: 1px solid transparent;
    }

    .list-group-item:hover {
        background-color: #f1f5f9;
        border-color: #e2e8f0;
    }

    .badge {
        padding: 0.6em 1em;
        font-weight: 600;
        border-radius: 8px;
    }

    /* Responsive Düzenlemeler */
    @media (max-width: 768px) {
        .welcome-banner {
            padding: 25px;
        }

        .stat-card {
            padding: 15px;
        }

        .stat-content h3 {
            font-size: 1.4rem;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Grafikler kaldırıldı
    });
</script>
{% endblock %}