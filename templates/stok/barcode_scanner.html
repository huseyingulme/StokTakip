{% extends "base.html" %}
{% load static %}
{% block title %}Barkod Okuyucu{% endblock %}
{% block page_title %}Barkod Okuyucu{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h5><i class="bi bi-upc-scan"></i> Barkod Okuyucu</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="barcodeInput" class="form-label">Barkod Numarası</label>
                    <div class="input-group">
                        <input type="text" class="form-control form-control-lg" id="barcodeInput" 
                               placeholder="Barkodu buraya girin veya tarayın" autofocus>
                        <button class="btn btn-primary" type="button" onclick="searchBarcode()">
                            <i class="bi bi-search"></i> Ara
                        </button>
                    </div>
                </div>
                <div id="barcodeResult" class="mt-3"></div>
            </div>
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body">
                        <h6><i class="bi bi-info-circle"></i> Kullanım</h6>
                        <ul class="mb-0">
                            <li>Barkod numarasını manuel olarak girebilirsiniz</li>
                            <li>Barkod okuyucu cihaz kullanabilirsiniz</li>
                            <li>Kamera ile QR kod tarayabilirsiniz</li>
                            <li>Enter tuşu ile hızlı arama yapabilirsiniz</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h6>Son Aranan Ürünler</h6>
            <div id="recentSearches" class="list-group"></div>
        </div>
    </div>
</div>

<!-- QR Code Scanner Modal -->
<div class="modal fade" id="qrScannerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">QR Kod Tarayıcı</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <video id="qrVideo" width="100%" style="max-width: 500px;"></video>
                <canvas id="qrCanvas" style="display: none;"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
let qrStream = null;

function searchBarcode() {
    const barcode = document.getElementById('barcodeInput').value.trim();
    if (!barcode) {
        alert('Lütfen bir barkod numarası girin');
        return;
    }
    
    fetch(`{% url 'stok:index' %}?search=${encodeURIComponent(barcode)}`)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const resultDiv = document.getElementById('barcodeResult');
            
            // Ürün listesini bul
            const productTable = doc.querySelector('.table');
            if (productTable) {
                resultDiv.innerHTML = '<h6>Bulgular:</h6>' + productTable.outerHTML;
            } else {
                resultDiv.innerHTML = '<div class="alert alert-warning">Ürün bulunamadı</div>';
            }
            
            // Son aramalara ekle
            addToRecentSearches(barcode);
        })
        .catch(error => {
            console.error('Hata:', error);
            document.getElementById('barcodeResult').innerHTML = 
                '<div class="alert alert-danger">Arama sırasında bir hata oluştu</div>';
        });
}

function addToRecentSearches(barcode) {
    let recent = JSON.parse(localStorage.getItem('recentBarcodeSearches') || '[]');
    if (!recent.includes(barcode)) {
        recent.unshift(barcode);
        recent = recent.slice(0, 10); // Son 10 aramayı tut
        localStorage.setItem('recentBarcodeSearches', JSON.stringify(recent));
    }
    updateRecentSearches();
}

function updateRecentSearches() {
    const recent = JSON.parse(localStorage.getItem('recentBarcodeSearches') || '[]');
    const container = document.getElementById('recentSearches');
    if (recent.length === 0) {
        container.innerHTML = '<p class="text-muted">Henüz arama yapılmadı</p>';
        return;
    }
    
    container.innerHTML = recent.map(barcode => 
        `<a href="#" class="list-group-item list-group-item-action" onclick="document.getElementById('barcodeInput').value='${barcode}'; searchBarcode(); return false;">
            <i class="bi bi-upc"></i> ${barcode}
        </a>`
    ).join('');
}

// Enter tuşu ile arama
document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchBarcode();
    }
});

// QR Code Scanner
function startQRScanner() {
    const video = document.getElementById('qrVideo');
    const canvas = document.getElementById('qrCanvas');
    const context = canvas.getContext('2d');
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
            qrStream = stream;
            video.srcObject = stream;
            video.play();
            
            function scanQR() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        document.getElementById('barcodeInput').value = code.data;
                        stopQRScanner();
                        searchBarcode();
                    } else {
                        requestAnimationFrame(scanQR);
                    }
                } else {
                    requestAnimationFrame(scanQR);
                }
            }
            scanQR();
        })
        .catch(err => {
            console.error('Kamera erişimi hatası:', err);
            alert('Kamera erişimi sağlanamadı');
        });
}

function stopQRScanner() {
    if (qrStream) {
        qrStream.getTracks().forEach(track => track.stop());
        qrStream = null;
    }
    const video = document.getElementById('qrVideo');
    video.srcObject = null;
}

// Modal kapatıldığında scanner'ı durdur
document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', stopQRScanner);

// Sayfa yüklendiğinde son aramaları göster
updateRecentSearches();
</script>
{% endblock %}

